from comopy import BaseTestCase, Input, IOStruct, Output

from ..branch import *
from .utils import translate_sv, write_sv


class TestBranch(BaseTestCase):
    class IO(IOStruct):
        fct3 = Input(3)
        rs1 = Input(32)
        rs2 = Input(32)
        simm = Input(32)
        data_addr = Input(32)
        pc = Input(32)
        jal = Input()
        jalr = Input()
        bcc = Input()

        pc_simm = Output(32)
        jreq = Output()
        jval = Output(32)

    TV = [
        IO(),
        # fct3,rs1,rs2,
        # F3, RS1, RS2, simm, daddr,  pc, jal,jalr,bcc, pcimm,jreq,jval
        # GEU
        (GEU, 0x2, 0x1, 0x500, 0x502, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (GEU, 0x1, 0x2, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        # LTU
        (LTU, 0x1, 0x2, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (LTU, 0x2, 0x1, 0x500, 0x502, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        # GE
        (GE, -0x1, -0x2, 0x500, 0x4FF, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (GE, -0x1, 0x2, 0x500, 0x4FF, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        (GE, 0x1, -0x2, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (GE, -0x2, -0x1, 0x500, 0x4FE, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        # LT
        (LT, 0x1, 0x2, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (LT, -0x1, -0x2, 0x500, 0x4FF, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        (LT, -0x2, -0x1, 0x500, 0x4FE, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (LT, 0x1, -0x2, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        # NE
        (NE, 0x1, 0x1, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        (NE, 0x1, 0, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        # EQ
        (EQ, 0x1, 0x1, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x1, 0x900),
        (EQ, 0x1, 0, 0x500, 0x501, 0x400, 0, 0, 1, 0x900, 0x0, 0x900),
        # jval and jreq
        # if jalr
        (EQ, 0x123, 0, 0x500, 0x623, 0x400, 0, 1, 1, 0x900, 0x1, 0x623),
        # if no bcc
        (EQ, 0x123, 0x123, 0x500, 0x623, 0x400, 0, 0, 0, 0x900, 0x0, 0x900),
        # if jal
        (EQ, 0x123, 0x123, 0x500, 0x623, 0x400, 1, 0, 0, 0x900, 0x1, 0x900),
    ]

    def test(self):
        top = Branch(name="top")
        self.simulate(top, self.TV)


def test_translate():
    top = Branch(name="Branch")
    sv = translate_sv(top)
    write_sv(sv, "branch.sv")
